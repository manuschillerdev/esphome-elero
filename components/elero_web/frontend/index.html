<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elero RF Bridge</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
import { h, render } from 'https://esm.sh/preact@10.19.3'
import { useState, useEffect, useMemo } from 'https://esm.sh/preact@10.19.3/hooks'
import htm from 'https://esm.sh/htm@3.1.1'
import { create } from 'https://esm.sh/zustand@4.4.7/vanilla'

const html = htm.bind(h)

// ─── Store ───────────────────────────────────────────────────────────────────

const store = create((set, get) => ({
  connected: false,
  config: { blinds: [], lights: [], device: '', freq: {} },
  states: {},      // address -> last RF packet
  rfPackets: [],   // RF packet history
  logs: [],        // ESPHome logs
  rfFilter: '',

  setConnected: (connected) => set({ connected }),
  setConfig: (config) => set({ config }),
  setRfFilter: (rfFilter) => set({ rfFilter }),

  addRfPacket: (pkt) => set(state => {
    const states = { ...state.states, [pkt.src]: pkt }
    const rfPackets = [...state.rfPackets, pkt].slice(-200)
    return { states, rfPackets }
  }),

  addLog: (log) => set(state => ({
    logs: [...state.logs, log].slice(-100)
  })),

  clearRfPackets: () => set({ rfPackets: [] }),
  clearLogs: () => set({ logs: [] }),
}))

// ─── WebSocket ───────────────────────────────────────────────────────────────

let ws = null
let reconnectTimer = null

function connect() {
  if (ws) {
    ws.onopen = ws.onclose = ws.onerror = ws.onmessage = null
    ws.close()
  }

  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:'
  ws = new WebSocket(`${proto}//${location.host}/elero/ws`)
  const socket = ws

  socket.onopen = () => {
    store.getState().setConnected(true)
    if (reconnectTimer) {
      clearTimeout(reconnectTimer)
      reconnectTimer = null
    }
  }

  socket.onclose = () => {
    store.getState().setConnected(false)
    if (ws === socket) {
      ws = null
      reconnectTimer = setTimeout(connect, 2000)
    }
  }

  socket.onerror = () => store.getState().setConnected(false)

  socket.onmessage = (e) => {
    const { event, data } = JSON.parse(e.data)
    const state = store.getState()
    if (event === 'config') state.setConfig(data)
    else if (event === 'rf') state.addRfPacket(data)
    else if (event === 'log') state.addLog(data)
  }
}

function sendCmd(address, action) {
  if (ws?.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'cmd', address, action }))
  }
}

// ─── Helpers ─────────────────────────────────────────────────────────────────

function formatTime(ms) {
  if (!ms) return ''
  const s = Math.floor(ms / 1000)
  return `${Math.floor(s / 60)}:${String(s % 60).padStart(2, '0')}`
}

function copyYaml(address, state) {
  const yaml = `  - platform: elero
    blind_address: ${address}
    channel: ${state?.ch || 0}
    remote_address: ${state?.dst || '0x000000'}
    name: "New Blind"
    # open_duration: 25s
    # close_duration: 22s`
  navigator.clipboard.writeText(yaml)
  alert('YAML copied to clipboard')
}

// ─── Components ──────────────────────────────────────────────────────────────

function useStore(selector) {
  const [state, setState] = useState(() => selector(store.getState()))
  useEffect(() => store.subscribe(s => setState(selector(s))), [])
  return state
}

function ConnectionStatus() {
  const connected = useStore(s => s.connected)
  const device = useStore(s => s.config.device)

  return html`
    <div class="flex items-center gap-2">
      <div class="w-3 h-3 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}"></div>
      <span class="text-sm text-gray-600">${connected ? 'Connected' : 'Disconnected'}</span>
      <span class="text-sm text-gray-400">${device}</span>
    </div>
  `
}

function BlindCard({ blind }) {
  const state = useStore(s => s.states[blind.address])

  return html`
    <div class="bg-white rounded-lg shadow p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-medium">${blind.name}</div>
          <div class="text-xs text-gray-500">
            ${blind.address} · ch ${blind.channel}
          </div>
          ${state && html`
            <div class="text-xs text-gray-400 mt-1">
              State: ${state.state || 'unknown'} · RSSI: ${state.rssi?.toFixed(1) || '-'} dBm
            </div>
          `}
        </div>
        <div class="flex gap-2">
          <button onClick=${() => sendCmd(blind.address, 'up')}
                  class="px-3 py-1.5 text-sm bg-green-100 text-green-700 rounded hover:bg-green-200">Open</button>
          <button onClick=${() => sendCmd(blind.address, 'stop')}
                  class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">Stop</button>
          <button onClick=${() => sendCmd(blind.address, 'down')}
                  class="px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200">Close</button>
          ${blind.tilt && html`
            <button onClick=${() => sendCmd(blind.address, 'tilt')}
                    class="px-3 py-1.5 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Tilt</button>
          `}
        </div>
      </div>
    </div>
  `
}

function ConfiguredBlinds() {
  const blinds = useStore(s => s.config.blinds)

  return html`
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Configured Blinds</h2>
      <div class="space-y-2">
        ${blinds?.map(b => html`<${BlindCard} key=${b.address} blind=${b} />`)}
        ${!blinds?.length && html`<div class="text-gray-500 text-sm">No blinds configured</div>`}
      </div>
    </div>
  `
}

function DiscoveredCard({ address }) {
  const state = useStore(s => s.states[address])

  return html`
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-mono text-sm">${address}</div>
          <div class="text-xs text-gray-500">
            Last seen: ${formatTime(state?.t)} · RSSI: ${state?.rssi?.toFixed(1) || '-'} dBm · ch ${state?.ch || '?'}
          </div>
        </div>
        <button onClick=${() => copyYaml(address, state)} class="text-sm text-blue-600 hover:underline">Copy YAML</button>
      </div>
    </div>
  `
}

function Discovered() {
  const states = useStore(s => s.states)
  const config = useStore(s => s.config)

  const discovered = useMemo(() => {
    const configured = new Set([
      ...(config.blinds || []).map(b => b.address),
      ...(config.lights || []).map(l => l.address)
    ])
    return Object.keys(states).filter(a => !configured.has(a))
  }, [states, config])

  return html`
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-2">Discovered</h2>
      <div class="space-y-2">
        ${discovered.map(addr => html`<${DiscoveredCard} key=${addr} address=${addr} />`)}
        ${!discovered.length && html`<div class="text-gray-500 text-sm">No new devices discovered</div>`}
      </div>
    </div>
  `
}

function RfPackets() {
  const rfPackets = useStore(s => s.rfPackets)
  const rfFilter = useStore(s => s.rfFilter)

  const filtered = useMemo(() => {
    let pkts = rfPackets
    if (rfFilter) {
      const f = rfFilter.toLowerCase()
      pkts = pkts.filter(p => p.src.toLowerCase().includes(f) || p.dst.toLowerCase().includes(f))
    }
    return pkts.slice(-50).reverse()
  }, [rfPackets, rfFilter])

  return html`
    <div class="mb-6">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">RF Packets</h2>
        <div class="flex gap-2">
          <input type="text" value=${rfFilter} onInput=${e => store.getState().setRfFilter(e.target.value)}
                 placeholder="Filter by address..." class="px-2 py-1 text-sm border rounded w-40" />
          <button onClick=${() => store.getState().clearRfPackets()} class="text-sm text-gray-500 hover:text-gray-700">Clear</button>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow max-h-64 overflow-y-auto">
        <table class="w-full text-xs font-mono">
          <thead class="bg-gray-50 sticky top-0">
            <tr>
              <th class="px-2 py-1 text-left">Time</th>
              <th class="px-2 py-1 text-left">Src</th>
              <th class="px-2 py-1 text-left">Dst</th>
              <th class="px-2 py-1 text-left">Type</th>
              <th class="px-2 py-1 text-left">Cmd/State</th>
              <th class="px-2 py-1 text-left">RSSI</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(pkt => html`
              <tr key=${pkt.t} class="border-t hover:bg-gray-50">
                <td class="px-2 py-1">${formatTime(pkt.t)}</td>
                <td class="px-2 py-1">${pkt.src}</td>
                <td class="px-2 py-1">${pkt.dst}</td>
                <td class="px-2 py-1">${pkt.type}</td>
                <td class="px-2 py-1">${pkt.type === '0x6a' ? pkt.cmd : pkt.state}</td>
                <td class="px-2 py-1">${pkt.rssi?.toFixed(1)}</td>
              </tr>
            `)}
          </tbody>
        </table>
        ${!filtered.length && html`<div class="p-4 text-center text-gray-500 text-sm">No packets</div>`}
      </div>
    </div>
  `
}

function Logs() {
  const logs = useStore(s => s.logs)

  const logClass = (level) => {
    if (level === 1) return 'text-red-600'
    if (level === 2) return 'text-yellow-600'
    return 'text-gray-700'
  }

  return html`
    <div>
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Logs</h2>
        <button onClick=${() => store.getState().clearLogs()} class="text-sm text-gray-500 hover:text-gray-700">Clear</button>
      </div>
      <div class="bg-white rounded-lg shadow max-h-48 overflow-y-auto">
        <div class="p-2 space-y-1 font-mono text-xs">
          ${logs.slice(-50).map(log => html`
            <div key=${log.t} class=${logClass(log.level)}>
              <span class="text-gray-400">${formatTime(log.t)}</span>
              <span> [${log.tag}] </span>
              <span>${log.msg}</span>
            </div>
          `)}
          ${!logs.length && html`<div class="text-gray-500">No logs</div>`}
        </div>
      </div>
    </div>
  `
}

function App() {
  useEffect(() => { connect() }, [])

  return html`
    <div class="max-w-4xl mx-auto">
      <div class="mb-4"><${ConnectionStatus} /></div>
      <${ConfiguredBlinds} />
      <${Discovered} />
      <${RfPackets} />
      <${Logs} />
    </div>
  `
}

render(html`<${App} />`, document.getElementById('app'))
  </script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div id="app"></div>
</body>
</html>
