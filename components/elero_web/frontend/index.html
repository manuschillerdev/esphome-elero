<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Elero Blind Manager</title>
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: '#1a73e8',
        'primary-dark': '#1557b0',
      }
    }
  }
}
</script>
<style>
[x-cloak] { display: none !important; }
.log-box { font-family: 'Menlo', 'Consolas', monospace; }
.log-error .log-level { color: #f38ba8; }
.log-warn .log-level { color: #fab387; }
.log-info .log-level { color: #a6e3a1; }
.log-debug .log-level { color: #89b4fa; }
.log-verbose .log-level { color: #6c7086; }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:.3} }
.scanning-dot { animation: pulse 1s infinite; }
</style>
</head>
<body class="bg-gray-100 text-gray-900 text-sm" x-data="eleroApp()" x-init="init()">
<div id="app" class="max-w-3xl mx-auto p-3 pb-10">

  <!-- Header -->
  <header class="flex items-center gap-2.5 bg-primary text-white px-4 py-3 rounded-lg mb-2.5">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
      <rect x="3" y="3" width="18" height="18" rx="2"/>
      <line x1="3" y1="9" x2="21" y2="9"/>
      <line x1="3" y1="15" x2="21" y2="15"/>
    </svg>
    <h1 class="text-lg font-semibold flex-1" x-text="deviceName || 'Elero Blind Manager'"></h1>
    <div class="flex items-center gap-2">
      <span class="text-xs opacity-75" x-text="connected ? uptimeStr : 'Disconnected'"></span>
      <span class="w-2 h-2 rounded-full" :class="connected ? 'bg-green-400' : 'bg-red-400'"></span>
    </div>
  </header>

  <!-- Tab bar -->
  <nav class="flex bg-white rounded-lg shadow mb-3 overflow-hidden">
    <template x-for="t in [{id:'devices',label:'Devices',badge:covers.length},{id:'discovery',label:'Discovery',badge:discoveredNew.length},{id:'log',label:'Log',badge:logEntries.length},{id:'config',label:'Configuration',badge:0}]" :key="t.id">
      <button class="flex-1 py-2.5 px-1 text-xs font-medium border-b-[3px] transition-colors flex items-center justify-center gap-1"
              :class="tab===t.id ? 'text-primary border-primary' : 'text-gray-500 border-transparent hover:text-gray-900 hover:bg-gray-50'"
              @click="tab=t.id">
        <span x-text="t.label"></span>
        <span x-show="t.badge>0" class="inline-flex items-center justify-center bg-primary text-white rounded-full text-[10px] min-w-[18px] h-[18px] px-1 font-bold"
              :class="t.id==='log' ? 'bg-orange-500' : ''" x-text="t.badge"></span>
      </button>
    </template>
  </nav>

  <div class="min-h-[200px]">

    <!-- ══════════════ DEVICES TAB ══════════════ -->
    <section x-show="tab==='devices'" x-cloak>
      <template x-if="covers.length === 0">
        <div class="text-center py-7 text-gray-500">No covers configured. Add covers in your ESPHome YAML.</div>
      </template>
      <template x-for="c in covers" :key="c.blind_address">
        <div class="bg-white rounded-lg shadow mb-3 p-3.5">
          <div class="flex justify-between items-start">
            <div>
              <div class="font-semibold" x-text="c.name"></div>
              <div class="text-xs text-gray-500 mt-0.5 flex flex-wrap gap-2">
                <span class="font-mono" x-text="c.blind_address"></span>
                <span x-show="c.channel" x-text="'CH '+c.channel"></span>
                <span x-show="c.rssi" :title="'RSSI: '+c.rssi.toFixed(1)+' dBm'" x-text="rssiIcon(c.rssi)"></span>
              </div>
            </div>
            <div class="flex flex-col items-end gap-1">
              <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold"
                    :class="stateClass(c.last_state)" x-text="stateLabel(c.last_state)"></span>
              <span x-show="c.adopted" class="text-[10px] text-primary border border-primary rounded px-1">adopted</span>
            </div>
          </div>

          <!-- Position bar -->
          <template x-if="c.position !== null && c.open_duration_ms > 0">
            <div class="mt-2">
              <div class="h-1.5 bg-gray-200 rounded-full overflow-hidden">
                <div class="h-full bg-primary transition-all duration-400" :style="'width:'+Math.round(c.position*100)+'%'"></div>
              </div>
              <div class="text-xs text-gray-500 mt-0.5" x-text="Math.round(c.position*100)+'%'"></div>
            </div>
          </template>

          <div class="text-xs text-gray-400 mt-1" x-text="'Last seen: '+relTime(c.last_seen_ms)"></div>

          <!-- Control buttons -->
          <div class="flex flex-wrap gap-1.5 mt-2">
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-green-50 text-green-700 border border-green-300 hover:bg-green-100" @click="coverCmd(c,'open')">Open</button>
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-gray-100 text-gray-700 border border-gray-300 hover:bg-gray-200" @click="coverCmd(c,'stop')">Stop</button>
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-red-50 text-red-700 border border-red-300 hover:bg-red-100" @click="coverCmd(c,'close')">Close</button>
            <button x-show="c.supports_tilt" class="px-3 py-1.5 rounded text-xs font-medium bg-blue-50 text-blue-700 border border-blue-300 hover:bg-blue-100" @click="coverCmd(c,'tilt')">Tilt</button>
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-white text-primary border border-primary hover:bg-blue-50 ml-auto"
                    @click="settingsOpen = settingsOpen===c.blind_address ? null : c.blind_address"
                    x-text="settingsOpen===c.blind_address ? 'Hide' : 'Settings'"></button>
          </div>

          <!-- Settings panel -->
          <div x-show="settingsOpen===c.blind_address" x-transition class="mt-3 border-t pt-2.5">
            <div class="grid grid-cols-[auto_1fr] gap-x-2 gap-y-2 text-xs">
              <label class="text-gray-500 self-center">Open (ms)</label>
              <input type="number" min="0" x-model.number="c._edit.open_duration_ms"
                     class="border rounded px-2 py-1 w-28 focus:outline-none focus:border-primary">
              <label class="text-gray-500 self-center">Close (ms)</label>
              <input type="number" min="0" x-model.number="c._edit.close_duration_ms"
                     class="border rounded px-2 py-1 w-28 focus:outline-none focus:border-primary">
              <label class="text-gray-500 self-center">Poll (ms)</label>
              <input type="number" min="0" x-model.number="c._edit.poll_interval_ms"
                     class="border rounded px-2 py-1 w-28 focus:outline-none focus:border-primary">
            </div>
            <div class="flex justify-end mt-2">
              <button class="px-3 py-1.5 rounded text-xs font-medium bg-primary text-white hover:bg-primary-dark" @click="saveSettings(c)">Save</button>
            </div>
          </div>
        </div>
      </template>
    </section>

    <!-- ══════════════ DISCOVERY TAB ══════════════ -->
    <section x-show="tab==='discovery'" x-cloak>
      <div class="bg-white rounded-lg shadow mb-3 overflow-hidden">
        <div class="flex justify-between items-center px-3.5 py-2.5 bg-gray-50 border-b font-semibold text-sm">
          <span>RF Scan</span>
          <div class="flex items-center gap-1.5 text-xs font-normal">
            <span class="w-2 h-2 rounded-full" :class="scanning ? 'bg-green-500 scanning-dot' : 'bg-gray-400'"></span>
            <span x-text="scanning ? 'Scanning...' : 'Idle'"></span>
          </div>
        </div>
        <div class="p-3.5">
          <div class="flex gap-1.5">
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-primary text-white hover:bg-primary-dark disabled:opacity-40" :disabled="scanning" @click="startScan()">Start Scan</button>
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-red-600 text-white hover:bg-red-700 disabled:opacity-40" :disabled="!scanning" @click="stopScan()">Stop Scan</button>
          </div>
          <p class="text-xs text-gray-500 mt-2">Operate your Elero remote during the scan to capture blinds.</p>
        </div>
      </div>

      <!-- Discovered blinds -->
      <template x-if="discoveredNew.length === 0 && !scanning">
        <div class="text-center py-7 text-gray-500">No unconfigured blinds found. Start a scan and press your remote.</div>
      </template>
      <template x-for="b in discoveredNew" :key="b.blind_address">
        <div class="bg-white rounded-lg shadow mb-3 p-3">
          <div class="flex justify-between items-center mb-1">
            <span class="font-mono text-sm" x-text="b.blind_address"></span>
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold" :class="stateClass(b.last_state)" x-text="stateLabel(b.last_state)"></span>
          </div>
          <div class="flex flex-wrap gap-2.5 text-xs text-gray-500">
            <span>CH <span x-text="b.channel"></span></span>
            <span>Remote <span class="font-mono" x-text="b.remote_address"></span></span>
            <span x-text="b.rssi.toFixed(1)+' dBm'"></span>
            <span x-text="b.times_seen+'x seen'"></span>
          </div>
          <div class="text-xs text-gray-400 mt-1" x-text="'Last seen: '+relTime(b.last_seen_ms)"></div>
          <div class="flex gap-1.5 mt-2">
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-white text-primary border border-primary hover:bg-blue-50" @click="showYamlBlind(b)">YAML</button>
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-primary text-white hover:bg-primary-dark" @click="startAdopt(b)">Adopt</button>
          </div>
        </div>
      </template>

      <!-- Already configured blinds -->
      <template x-for="b in discoveredKnown" :key="b.blind_address">
        <div class="bg-white rounded-lg shadow mb-3 p-3 opacity-70">
          <div class="flex justify-between items-center mb-1">
            <span class="font-mono text-sm" x-text="b.blind_address"></span>
            <span class="text-xs text-green-600 font-semibold" x-text="b.already_adopted ? 'Adopted' : 'Configured'"></span>
          </div>
          <div class="flex flex-wrap gap-2.5 text-xs text-gray-500">
            <span>CH <span x-text="b.channel"></span></span>
            <span x-text="b.rssi.toFixed(1)+' dBm'"></span>
            <span x-text="b.times_seen+'x seen'"></span>
          </div>
        </div>
      </template>

      <div x-show="allDiscovered.length>0" class="text-center mt-3">
        <button class="px-3 py-1.5 rounded text-xs font-medium bg-white text-primary border border-primary hover:bg-blue-50" @click="downloadYaml()">Download all YAML</button>
      </div>
    </section>

    <!-- ══════════════ LOG TAB ══════════════ -->
    <section x-show="tab==='log'" x-cloak>
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="flex flex-wrap justify-between items-center gap-2 px-3.5 py-2 bg-gray-50 border-b text-xs">
          <div class="flex items-center gap-1.5">
            <span class="w-2 h-2 rounded-full" :class="logCapture ? 'bg-green-500 scanning-dot' : 'bg-gray-400'"></span>
            <button class="px-2 py-1 rounded font-medium bg-primary text-white hover:bg-primary-dark disabled:opacity-40" :disabled="logCapture" @click="startCapture()">Start</button>
            <button class="px-2 py-1 rounded font-medium bg-red-600 text-white hover:bg-red-700 disabled:opacity-40" :disabled="!logCapture" @click="stopCapture()">Stop</button>
            <span>Level:</span>
            <select x-model="logLevel" class="border rounded px-1 py-0.5 text-xs">
              <option value="5">VERBOSE</option>
              <option value="4">DEBUG</option>
              <option value="3">INFO</option>
              <option value="2">WARN</option>
              <option value="1">ERROR</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <label class="flex items-center gap-1"><input type="checkbox" x-model="logAutoScroll"> Auto-scroll</label>
            <button class="px-2 py-1 rounded font-medium bg-white text-primary border border-primary hover:bg-blue-50" @click="clearLog()">Clear</button>
          </div>
        </div>
        <div id="log-box" class="log-box max-h-[420px] overflow-y-auto text-[11px] leading-relaxed p-2 bg-[#1e1e2e] rounded-b-lg">
          <template x-if="filteredLog.length === 0">
            <div class="text-gray-500 text-center py-4">No log entries. <span x-show="!logCapture">Start capture first.</span></div>
          </template>
          <template x-for="e in filteredLog" :key="e.t+'_'+e.idx">
            <div class="flex gap-2 py-px" :class="'log-'+e.level_str">
              <span class="text-gray-500 min-w-[60px]" x-text="fmtTs(e.t)"></span>
              <span class="log-level min-w-[48px] font-bold" x-text="e.level_str.toUpperCase().padEnd(5)"></span>
              <span class="text-cyan-400 min-w-[96px]" x-text="e.tag"></span>
              <span class="text-gray-300 break-all" x-html="linkAddrs(e.msg)"></span>
            </div>
          </template>
        </div>
      </div>
    </section>

    <!-- ══════════════ CONFIGURATION TAB ══════════════ -->
    <section x-show="tab==='config'" x-cloak>

      <!-- Frequency -->
      <div class="bg-white rounded-lg shadow mb-3 overflow-hidden">
        <div class="px-3.5 py-2.5 bg-gray-50 border-b font-semibold text-sm">CC1101 Frequency</div>
        <div class="p-3.5">
          <div class="mb-2.5">
            <select class="border rounded px-2 py-1.5 text-xs w-full" @change="applyPreset($event.target.value)">
              <option value="">-- Preset --</option>
              <option value="21,71,7a">868.35 MHz (Standard Elero)</option>
              <option value="21,65,c0">868.95 MHz (Alternative)</option>
              <option value="10,A7,62">433.92 MHz</option>
            </select>
          </div>
          <div class="flex gap-2.5 flex-wrap mb-2.5">
            <div class="flex flex-col gap-0.5">
              <label class="text-[10px] text-gray-500">freq2</label>
              <input class="font-mono border rounded px-2 py-1 w-20 text-xs focus:outline-none focus:border-primary" x-model="freq.freq2" maxlength="4">
            </div>
            <div class="flex flex-col gap-0.5">
              <label class="text-[10px] text-gray-500">freq1</label>
              <input class="font-mono border rounded px-2 py-1 w-20 text-xs focus:outline-none focus:border-primary" x-model="freq.freq1" maxlength="4">
            </div>
            <div class="flex flex-col gap-0.5">
              <label class="text-[10px] text-gray-500">freq0</label>
              <input class="font-mono border rounded px-2 py-1 w-20 text-xs focus:outline-none focus:border-primary" x-model="freq.freq0" maxlength="4">
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-primary text-white hover:bg-primary-dark" @click="setFrequency()">Apply</button>
            <span class="text-xs text-gray-500" x-text="freqStatus"></span>
          </div>
          <p class="text-xs text-gray-500 mt-2">Hex values (e.g. 0x7a or 7a). Changes take effect immediately.</p>
        </div>
      </div>

      <!-- Packet Dump -->
      <div class="bg-white rounded-lg shadow mb-3 overflow-hidden">
        <div class="flex justify-between items-center px-3.5 py-2.5 bg-gray-50 border-b font-semibold text-sm">
          <span>Packet Dump</span>
          <div class="flex items-center gap-1.5">
            <span class="inline-block px-2 py-0.5 rounded-full text-[10px] font-semibold"
                  :class="dumpActive ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'"
                  x-text="dumpActive ? 'Active' : 'Idle'"></span>
            <span x-show="dumpPackets.length>0" class="inline-block px-2 py-0.5 rounded-full text-[10px] font-semibold bg-blue-100 text-blue-700" x-text="dumpPackets.length"></span>
          </div>
        </div>
        <div class="p-3.5">
          <div class="flex gap-1.5 mb-2">
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-primary text-white hover:bg-primary-dark disabled:opacity-40" :disabled="dumpActive" @click="startDump()">Start Dump</button>
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-red-600 text-white hover:bg-red-700 disabled:opacity-40" :disabled="!dumpActive" @click="stopDump()">Stop</button>
            <button class="px-3 py-1.5 rounded text-xs font-medium bg-white text-primary border border-primary hover:bg-blue-50" @click="clearDump()">Clear</button>
          </div>
          <p class="text-xs text-gray-500 mb-2">Records all received RF packets (max 50). Green = valid, red = rejected.</p>
          <div x-show="dumpPackets.length>0" class="overflow-x-auto max-h-[360px] overflow-y-auto">
            <table class="w-full text-[11px] border-collapse">
              <thead><tr class="bg-gray-50"><th class="text-left p-1 border-b-2 whitespace-nowrap">Time</th><th class="text-left p-1 border-b-2">Len</th><th class="text-left p-1 border-b-2">Status</th><th class="text-left p-1 border-b-2">Reason</th><th class="text-left p-1 border-b-2">Hex</th></tr></thead>
              <tbody>
                <template x-for="p in [...dumpPackets].reverse()" :key="p.t">
                  <tr :class="p.valid ? 'bg-green-50' : 'bg-red-50'">
                    <td class="p-1 border-b" x-text="p.t"></td>
                    <td class="p-1 border-b" x-text="p.len"></td>
                    <td class="p-1 border-b"><span :class="p.valid ? 'text-green-700 font-bold' : 'text-red-700 font-bold'" x-text="p.valid ? 'OK' : 'ERR'"></span></td>
                    <td class="p-1 border-b" x-text="p.reason||''"></td>
                    <td class="p-1 border-b font-mono break-all" x-text="p.hex"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Device Info -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-3.5 py-2.5 bg-gray-50 border-b font-semibold text-sm">Device Info</div>
        <div class="p-3.5 grid grid-cols-[130px_1fr] gap-1.5 text-xs">
          <span class="text-gray-500 font-medium">Device</span><span x-text="deviceName||'-'"></span>
          <span class="text-gray-500 font-medium">Uptime</span><span x-text="uptimeStr"></span>
          <span class="text-gray-500 font-medium">Frequency</span><span class="font-mono" x-text="freq.freq2+' / '+freq.freq1+' / '+freq.freq0"></span>
          <span class="text-gray-500 font-medium">Covers</span><span x-text="covers.filter(c=>!c.adopted).length+' configured, '+covers.filter(c=>c.adopted).length+' adopted'"></span>
        </div>
      </div>
    </section>

  </div><!-- /tab-content -->

  <!-- Toast -->
  <div class="fixed bottom-6 left-1/2 -translate-x-1/2 px-5 py-2.5 rounded-lg text-sm z-50 transition-opacity whitespace-nowrap"
       :class="toast.show ? 'opacity-100' : 'opacity-0 pointer-events-none'"
       :style="toast.error ? 'background:#d32f2f;color:#fff' : 'background:#333;color:#fff'"
       x-text="toast.msg"></div>

  <!-- Adopt Modal -->
  <div class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center" :class="adoptTarget ? '' : 'hidden'" @click.self="adoptTarget=null">
    <div x-show="adoptTarget" class="bg-white rounded-xl w-[90%] max-w-[520px] max-h-[90vh] overflow-y-auto shadow-xl">
      <div class="px-4 py-3 border-b flex justify-between items-center">
        <h3 class="font-semibold">Adopt blind <span class="font-mono" x-text="adoptTarget?.blind_address"></span></h3>
        <button class="text-2xl text-gray-400 hover:text-gray-900" @click="adoptTarget=null">&times;</button>
      </div>
      <div class="p-4">
        <label class="block text-sm mb-1">Friendly name</label>
        <input type="text" x-model="adoptName" placeholder="e.g. Balcony" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:border-primary" autofocus>
        <p class="text-xs text-gray-500 mt-2">This blind will appear in the Devices tab. For permanent HA integration, add the YAML to your config and reflash.</p>
      </div>
      <div class="px-4 py-3 border-t flex justify-end gap-2">
        <button class="px-3 py-1.5 rounded text-xs font-medium bg-white text-primary border border-primary hover:bg-blue-50" @click="adoptTarget=null">Cancel</button>
        <button class="px-3 py-1.5 rounded text-xs font-medium bg-primary text-white hover:bg-primary-dark" @click="confirmAdopt()">Adopt</button>
      </div>
    </div>
  </div>

  <!-- YAML Modal -->
  <div class="fixed inset-0 bg-black/50 z-40 flex items-center justify-center" :class="yamlContent ? '' : 'hidden'" @click.self="yamlContent=null">
    <div x-show="yamlContent" class="bg-white rounded-xl w-[90%] max-w-[520px] max-h-[90vh] overflow-y-auto shadow-xl">
      <div class="px-4 py-3 border-b flex justify-between items-center">
        <h3 class="font-semibold">YAML Snippet</h3>
        <button class="text-2xl text-gray-400 hover:text-gray-900" @click="yamlContent=null">&times;</button>
      </div>
      <div class="p-4">
        <p class="text-xs text-gray-500 mb-2">Add this to your ESPHome configuration for permanent HA integration:</p>
        <pre class="bg-[#263238] text-gray-200 rounded-lg p-3 text-xs font-mono whitespace-pre overflow-x-auto max-h-[360px] overflow-y-auto" x-text="yamlContent"></pre>
      </div>
      <div class="px-4 py-3 border-t flex justify-end gap-2">
        <button class="px-3 py-1.5 rounded text-xs font-medium bg-white text-primary border border-primary hover:bg-blue-50" @click="copyYaml()">Copy</button>
        <button class="px-3 py-1.5 rounded text-xs font-medium bg-primary text-white hover:bg-primary-dark" @click="yamlContent=null">Close</button>
      </div>
    </div>
  </div>

</div><!-- /app -->

<script>
const STATE_LABELS = {
  top:'Top', bottom:'Bottom', intermediate:'Intermediate', tilt:'Tilt',
  blocking:'Blocking', overheated:'Overheated', timeout:'Timeout',
  start_moving_up:'Starting Up', start_moving_down:'Starting Down',
  moving_up:'Moving Up', moving_down:'Moving Down', stopped:'Stopped',
  top_tilt:'Top (Tilt)', bottom_tilt:'Bottom (Tilt)', unknown:'Unknown',
  on:'On', off:'Off'
}

function relTime(ms) {
  if (!ms) return 'never'
  const diff = Math.floor((Date.now() - ms) / 1000)
  if (diff < 5) return 'just now'
  if (diff < 60) return `${diff}s ago`
  if (diff < 3600) return `${Math.floor(diff/60)}m ago`
  return `${Math.floor(diff/3600)}h ago`
}

function fmtTs(ms) {
  const s = Math.floor(ms / 1000)
  const h = Math.floor(s / 3600) % 24
  const m = Math.floor(s / 60) % 60
  const sec = s % 60
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`
}

function uptimeFmt(ms) {
  if (!ms) return ''
  const s = Math.floor(ms / 1000)
  const h = Math.floor(s / 3600)
  const m = Math.floor((s % 3600) / 60)
  const sec = s % 60
  if (h > 0) return `${h}h ${m}m ${sec}s`
  if (m > 0) return `${m}m ${sec}s`
  return `${sec}s`
}

function eleroApp() {
  return {
    tab: 'devices',
    connected: false,
    eventSource: null,
    reconnectTimer: null,

    deviceName: '',
    uptimeMs: 0,
    get uptimeStr() { return uptimeFmt(this.uptimeMs) },

    covers: [],
    settingsOpen: null,

    scanning: false,
    allDiscovered: [],
    get discoveredNew() { return this.allDiscovered.filter(b => !b.already_configured && !b.already_adopted) },
    get discoveredKnown() { return this.allDiscovered.filter(b => b.already_configured || b.already_adopted) },

    adoptTarget: null,
    adoptName: '',
    yamlContent: null,

    logCapture: false,
    logLevel: '3',
    logAutoScroll: true,
    logEntries: [],
    get filteredLog() { return this.logEntries.filter(e => e.level <= parseInt(this.logLevel)) },

    freq: { freq2: '', freq1: '', freq0: '' },
    freqStatus: '',

    dumpActive: false,
    dumpPackets: [],

    toast: { show: false, error: false, msg: '' },
    _toastTimer: null,

    // ── Lifecycle ──
    init() { this.connect() },

    // ── SSE connection ──
    connect() {
      if (this.eventSource) {
        this.eventSource.close()
        this.eventSource = null
      }

      this.eventSource = new EventSource('/elero/events')

      this.eventSource.onopen = () => {
        this.connected = true
        if (this.reconnectTimer) {
          clearTimeout(this.reconnectTimer)
          this.reconnectTimer = null
        }
      }

      this.eventSource.onerror = () => {
        this.connected = false
        this.eventSource.close()
        this.eventSource = null
        this.reconnectTimer = setTimeout(() => this.connect(), 2000)
      }

      // Full state event
      this.eventSource.addEventListener('state', (e) => {
        const data = JSON.parse(e.data)
        this.applyState(data)
      })

      // Incremental covers
      this.eventSource.addEventListener('covers', (e) => {
        const data = JSON.parse(e.data)
        this.covers = data.map(c => ({
          ...c,
          _edit: {
            open_duration_ms: c.open_duration_ms,
            close_duration_ms: c.close_duration_ms,
            poll_interval_ms: c.poll_interval_ms,
          }
        }))
      })

      // Incremental discovered
      this.eventSource.addEventListener('discovered', (e) => {
        const data = JSON.parse(e.data)
        this.scanning = data.scanning
        this.allDiscovered = data.blinds || []
      })

      // Log entries
      this.eventSource.addEventListener('log', (e) => {
        const data = JSON.parse(e.data)
        if (Array.isArray(data) && data.length > 0) {
          const newEntries = data.map((entry, i) => ({ ...entry, idx: this.logEntries.length + i }))
          this.logEntries.push(...newEntries)
          if (this.logEntries.length > 500) this.logEntries.splice(0, this.logEntries.length - 500)
          if (this.logAutoScroll) {
            this.$nextTick(() => {
              const box = document.getElementById('log-box')
              if (box) box.scrollTop = box.scrollHeight
            })
          }
        }
      })

      // Packets
      this.eventSource.addEventListener('packets', (e) => {
        const data = JSON.parse(e.data)
        this.dumpActive = data.dump_active
        this.dumpPackets = data.packets || []
      })
    },

    applyState(data) {
      this.deviceName = data.device_name || ''
      this.uptimeMs = data.uptime_ms || 0
      this.scanning = data.scanning || false
      this.logCapture = data.log_capture || false
      this.dumpActive = data.dump_active || false
      if (data.freq) {
        this.freq.freq2 = data.freq.freq2 || this.freq.freq2
        this.freq.freq1 = data.freq.freq1 || this.freq.freq1
        this.freq.freq0 = data.freq.freq0 || this.freq.freq0
      }
      if (data.covers) {
        this.covers = data.covers.map(c => ({
          ...c,
          _edit: {
            open_duration_ms: c.open_duration_ms,
            close_duration_ms: c.close_duration_ms,
            poll_interval_ms: c.poll_interval_ms,
          }
        }))
      }
      if (data.discovered) {
        this.scanning = data.discovered.scanning
        this.allDiscovered = data.discovered.blinds || []
      }
    },

    // ── HTTP POST helper ──
    async post(url, body = null) {
      const resp = await fetch(url, {
        method: 'POST',
        headers: body ? { 'Content-Type': 'application/json' } : {},
        body: body ? JSON.stringify(body) : undefined
      })
      return resp.json()
    },

    // ── Toast ──
    showToast(msg, isError = false) {
      if (this._toastTimer) clearTimeout(this._toastTimer)
      this.toast = { show: true, error: isError, msg }
      this._toastTimer = setTimeout(() => { this.toast.show = false }, 3500)
    },

    // ── Cover controls ──
    async coverCmd(c, action) {
      try {
        const res = await this.post('/elero/api/cover', { address: c.blind_address, action })
        if (res.ok) {
          this.showToast(`${c.name}: ${action} sent`)
        } else {
          this.showToast(res.error || 'Command failed', true)
        }
      } catch (e) {
        this.showToast(`Command failed: ${e.message}`, true)
      }
    },

    async saveSettings(c) {
      try {
        const res = await this.post('/elero/api/settings', {
          address: c.blind_address,
          open_duration: c._edit.open_duration_ms,
          close_duration: c._edit.close_duration_ms,
          poll_interval: c._edit.poll_interval_ms,
        })
        if (res.ok) {
          this.showToast(`${c.name}: settings saved`)
          this.settingsOpen = null
        } else {
          this.showToast(res.error || 'Save failed', true)
        }
      } catch (e) {
        this.showToast(`Save failed: ${e.message}`, true)
      }
    },

    // ── Discovery ──
    async startScan() {
      try {
        const res = await this.post('/elero/api/scan/start')
        if (res.ok) this.showToast('Scan started')
        else this.showToast(res.error || 'Scan start failed', true)
      } catch (e) { this.showToast(`Scan start failed: ${e.message}`, true) }
    },

    async stopScan() {
      try {
        const res = await this.post('/elero/api/scan/stop')
        if (res.ok) this.showToast('Scan stopped')
        else this.showToast(res.error || 'Scan stop failed', true)
      } catch (e) { this.showToast(`Scan stop failed: ${e.message}`, true) }
    },

    startAdopt(b) {
      this.adoptTarget = b
      this.adoptName = ''
    },

    async confirmAdopt() {
      if (!this.adoptTarget) return
      try {
        const res = await this.post('/elero/api/adopt', {
          address: this.adoptTarget.blind_address,
          name: this.adoptName || this.adoptTarget.blind_address
        })
        if (res.ok) {
          this.showToast(`Adopted as "${this.adoptName || this.adoptTarget.blind_address}"`)
          this.adoptTarget = null
          this.tab = 'devices'
        } else {
          this.showToast(res.error || 'Adopt failed', true)
        }
      } catch (e) { this.showToast(`Adopt failed: ${e.message}`, true) }
    },

    showYamlBlind(b) {
      this.yamlContent =
        `cover:\n` +
        `  - platform: elero\n` +
        `    blind_address: ${b.blind_address}\n` +
        `    channel: ${b.channel}\n` +
        `    remote_address: ${b.remote_address}\n` +
        `    name: "My Blind"\n` +
        `    # open_duration: 25s\n` +
        `    # close_duration: 22s\n` +
        `    hop: ${b.hop}\n` +
        `    payload_1: ${b.payload_1}\n` +
        `    payload_2: ${b.payload_2}\n` +
        `    pck_inf1: ${b.pck_inf1}\n` +
        `    pck_inf2: ${b.pck_inf2}\n`
    },

    async downloadYaml() {
      try {
        const resp = await fetch('/elero/api/yaml')
        const yaml = await resp.text()
        const blob = new Blob([yaml], { type: 'text/plain' })
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.href = url
        a.download = 'elero_blinds.yaml'
        a.click()
        URL.revokeObjectURL(url)
      } catch (e) { this.showToast(`YAML download failed: ${e.message}`, true) }
    },

    copyYaml() {
      navigator.clipboard?.writeText(this.yamlContent)
        .then(() => this.showToast('Copied!'))
        .catch(() => this.showToast('Copy failed', true))
    },

    // ── Log ──
    async startCapture() {
      try {
        const res = await this.post('/elero/api/log/start')
        if (res.ok) {
          this.logCapture = true
          this.showToast('Log capture started')
        } else this.showToast(res.error || 'Failed', true)
      } catch (e) { this.showToast(`Failed: ${e.message}`, true) }
    },

    async stopCapture() {
      try {
        const res = await this.post('/elero/api/log/stop')
        if (res.ok) {
          this.logCapture = false
          this.showToast('Log capture stopped')
        } else this.showToast(res.error || 'Failed', true)
      } catch (e) { this.showToast(`Failed: ${e.message}`, true) }
    },

    async clearLog() {
      try {
        const res = await this.post('/elero/api/log/clear')
        if (res.ok) {
          this.logEntries = []
          this.showToast('Log cleared')
        } else this.showToast(res.error || 'Failed', true)
      } catch (e) { this.showToast(`Failed: ${e.message}`, true) }
    },

    linkAddrs(msg) {
      if (!msg) return ''
      const addrMap = {}
      for (const c of this.covers) addrMap[c.blind_address] = c.name
      const safe = msg.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
      return safe.replace(/0x[0-9a-fA-F]{6}/g, m => {
        const name = addrMap[m.toLowerCase()] || addrMap[m]
        return name ? `${m}<span class="text-green-400 font-bold">(${name})</span>` : m
      })
    },

    // ── Frequency ──
    applyPreset(v) {
      if (!v) return
      const [f2, f1, f0] = v.split(',')
      this.freq = { freq2: '0x'+f2, freq1: '0x'+f1, freq0: '0x'+f0 }
    },

    async setFrequency() {
      this.freqStatus = 'Applying...'
      try {
        const res = await this.post('/elero/api/frequency', {
          freq2: this.freq.freq2,
          freq1: this.freq.freq1,
          freq0: this.freq.freq0
        })
        this.freqStatus = ''
        if (res.ok) {
          this.showToast(`Frequency set: ${this.freq.freq2} ${this.freq.freq1} ${this.freq.freq0}`)
        } else {
          this.showToast(res.error || 'Failed', true)
        }
      } catch (e) { this.freqStatus = ''; this.showToast(`Failed: ${e.message}`, true) }
    },

    // ── Packet dump ──
    async startDump() {
      try {
        const res = await this.post('/elero/api/dump/start')
        if (res.ok) {
          this.dumpActive = true
          this.showToast('Packet dump started')
        } else this.showToast(res.error || 'Failed', true)
      } catch (e) { this.showToast(`Failed: ${e.message}`, true) }
    },

    async stopDump() {
      try {
        const res = await this.post('/elero/api/dump/stop')
        if (res.ok) {
          this.dumpActive = false
          this.showToast('Packet dump stopped')
        } else this.showToast(res.error || 'Failed', true)
      } catch (e) { this.showToast(`Failed: ${e.message}`, true) }
    },

    async clearDump() {
      try {
        const res = await this.post('/elero/api/dump/clear')
        if (res.ok) {
          this.dumpPackets = []
          this.showToast('Dump cleared')
        } else this.showToast(res.error || 'Failed', true)
      } catch (e) { this.showToast(`Failed: ${e.message}`, true) }
    },

    // ── Helpers ──
    stateLabel: s => STATE_LABELS[s] || s || 'Unknown',
    stateClass(s) {
      const map = {
        top: 'bg-green-100 text-green-700',
        bottom: 'bg-red-100 text-red-700',
        moving_up: 'bg-orange-100 text-orange-700',
        moving_down: 'bg-orange-100 text-orange-700',
        start_moving_up: 'bg-orange-100 text-orange-700',
        start_moving_down: 'bg-orange-100 text-orange-700',
        intermediate: 'bg-blue-100 text-blue-700',
        stopped: 'bg-blue-100 text-blue-700',
        tilt: 'bg-purple-100 text-purple-700',
        top_tilt: 'bg-purple-100 text-purple-700',
        bottom_tilt: 'bg-purple-100 text-purple-700',
        blocking: 'bg-red-100 text-red-700',
        overheated: 'bg-red-100 text-red-700',
        timeout: 'bg-red-100 text-red-700',
      }
      return map[s] || 'bg-gray-100 text-gray-500'
    },
    rssiIcon(rssi) {
      if (rssi >= -65) return '\u2582\u2584\u2588 ' + rssi.toFixed(1) + ' dBm'
      if (rssi >= -80) return '\u2582\u2584\u2591 ' + rssi.toFixed(1) + ' dBm'
      return '\u2582\u2591\u2591 ' + rssi.toFixed(1) + ' dBm'
    },
    relTime,
    fmtTs,
  }
}
</script>
</body>
</html>
